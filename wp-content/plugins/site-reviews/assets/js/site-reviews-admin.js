"use strict";var GLSR={addons:{},keys:{ENTER:13,ESC:27,SPACE:32,UP:38,DOWN:40},pinned:{},shortcode:{},translation:{},colorControls:function(){"object"==typeof jQuery.wp&&"function"==typeof jQuery.wp.wpColorPicker&&jQuery(document).find('input[type="text"].color-picker-hex').each(function(){var e=jQuery(this),t=e.data("colorpicker")||{};e.wpColorPicker(t)})},dismissNotices:function(){jQuery(".notice.is-dismissible").each(function(){var e=jQuery(this);e.fadeTo(100,0,function(){e.slideUp(100,function(){e.remove()})})})},getURLParameter:function(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[null,""])[1].replace(/\+/g,"%20"))||null},insertNotices:function(e){(e=e||!1)&&(jQuery("#glsr-notices").length||(jQuery("#message.notice").remove(),jQuery("form#post").before('<div id="glsr-notices" />')),jQuery("#glsr-notices").html(e),jQuery(document).trigger("wp-updates-notice-added"))},isUndefined:function(e){return void 0===e},normalizeValue:function(e){return-1<["true","on","1"].indexOf(e)||!(-1<["false","off","0"].indexOf(e))&&e},normalizeValues:function(e){return e.map(GLSR.normalizeValue)},onChangeStatus:function(s){var e=this.href.match(/post=([0-9]+)/)[1],t=this.href.match(/action=([a-z]+)/)[1];if(!GLSR.isUndefined(t)&&!GLSR.isUndefined(e)){var i={action:"change-review-status",status:t,post_id:e};GLSR.postAjax(s,i,function(e){var t=jQuery(s.target);t.closest("tr").removeClass("status-pending status-publish").addClass(e.class),t.closest("td.column-title").find("strong").html(e.link)})}},onClearLog:function(e){GLSR.postAjax(e,{action:"clear-log"},function(e){GLSR.insertNotices(e.notices),jQuery("#log-file").val(e.log)})},onFieldChange:function(){var t=jQuery(this).closest("form").find("[data-depends]");if(t.length)for(var e=this.getAttribute("name"),s=this.getAttribute("type"),i=0;i<t.length;i++)try{var n,o=JSON.parse(t[i].getAttribute("data-depends"));if(o.name!==e)continue;n="checkbox"===s?!!this.checked:jQuery.isArray(o.value)?-1!==jQuery.inArray(GLSR.normalizeValue(this.value),GLSR.normalizeValues(o.value)):GLSR.normalizeValue(o.value)===GLSR.normalizeValue(this.value),GLSR.toggleHiddenField(t[i],n)}catch(e){console.error("JSON Error: "+t[i])}},pointers:function(e){jQuery(e.target).pointer({content:e.options.content,position:e.options.position,close:function(){jQuery.post(ajaxurl,{pointer:e.id,action:"dismiss-wp-pointer"})}}).pointer("open").pointer("sendToTop"),jQuery(document).on("wp-window-resized",function(){jQuery(e.target).pointer("reposition")})},postAjax:function(e,t,s){e.preventDefault();var i=jQuery(e.target);if(!i.is(":disabled")){var n={action:site_reviews.action,request:t};i.prop("disabled",!0),jQuery.post(site_reviews.ajaxurl,n,function(e){"function"==typeof s&&s(e),i.prop("disabled",!1)},"json")}},textareaResize:function(e){var t=e[0];t.style.height="auto",t.style.height=320<t.scrollHeight?t.scrollHeight+"px":"320px"},toggleHiddenField:function(e,t){var s=jQuery(e).closest(".glsr-field");s.length&&(t?s.removeClass("hidden"):s.addClass("hidden"))}};GLSR.pinned.events=function(){var t=jQuery("#pinned-status-select");jQuery("a.cancel-pinned-status").on("click",function(e){e.preventDefault(),t.slideUp("fast").siblings("a.edit-pinned-status").show().focus(),t.find("select").val("0"===jQuery("#hidden-pinned-status").val()?1:0)}),jQuery("a.edit-pinned-status").on("click",function(e){e.preventDefault(),t.is(":hidden")&&(t.slideDown("fast",function(){t.find("select").focus()}),jQuery(this).hide())}),jQuery("a.save-pinned-status").on("click",function(e){e.preventDefault(),t.slideUp("fast").siblings("a.edit-pinned-status").show().focus(),GLSR.pinned.save(jQuery(this))}),jQuery("table").on("click","td.sticky i",GLSR.pinned.onToggle)},GLSR.pinned.onToggle=function(){var t=jQuery(this),e={action:site_reviews.action,request:{action:"toggle-pinned",id:t[0].getAttribute("data-id")}};jQuery.post(site_reviews.ajaxurl,e,function(e){e.pinned?t.addClass("pinned"):t.removeClass("pinned")})},GLSR.pinned.save=function(t){var e={action:site_reviews.action,request:{action:"toggle-pinned",id:jQuery("#post_ID").val(),pinned:jQuery("#pinned-status").val()}};jQuery.post(site_reviews.ajaxurl,e,function(e){jQuery("#pinned-status").val(0|!e.pinned),jQuery("#hidden-pinned-status").val(0|e.pinned),jQuery("#pinned-status-text").text(e.pinned?t.data("yes"):t.data("no")),GLSR.insertNotices(e.notices)})},GLSR.search=function(e,t){this.el="[object String]"===Object.prototype.toString.call(e)?jQuery(e):e,this.options=t,this.searchTerm=null,this.init()},GLSR.search.prototype={defaults:{action:null,exclude:[],onInit:null,onResultClick:null,results:{},selected:-1,selectedClass:"glsr-selected-result",selectorEntries:".glsr-strings-table tbody",selectorResults:".glsr-search-results",selectorSearch:".glsr-search-input"},init:function(){this.options=jQuery.extend({},this.defaults,this.options),this.el.length&&(this.options.entriesEl=this.el.parent().find(this.options.selectorEntries),this.options.resultsEl=this.el.find(this.options.selectorResults),this.options.searchEl=this.el.find(this.options.selectorSearch),this.options.searchEl.attr("aria-describedby","live-search-desc"),"function"==typeof this.options.onInit&&this.options.onInit.call(this),this.initEvents())},initEvents:function(){this.options.searchEl.on("input",_.debounce(this.onSearchInput.bind(this),500)),this.options.searchEl.on("keyup",this.onSearchKeyup.bind(this)),jQuery(document).on("click",this.onDocumentClick.bind(this)),jQuery(document).on("keydown",this.onDocumentKeydown.bind(this))},abort:function(){void 0!==this.searchRequest&&this.searchRequest.abort()},clearResults:function(){this.abort(),this.options.resultsEl.empty(),this.el.removeClass("is-active"),jQuery("body").removeClass("glsr-focus")},displayResults:function(e){jQuery("body").addClass("glsr-focus"),this.options.resultsEl.append(e),this.options.resultsEl.children("span").on("click",this.onResultClick.bind(this))},navigateResults:function(e){this.options.selected+=e,this.options.results.removeClass(this.options.selectedClass),this.options.selected<0&&(this.options.selected=-1,this.options.searchEl.focus()),this.options.selected>=this.options.results.length&&(this.options.selected=this.options.results.length-1),0<=this.options.selected&&this.options.results.eq(this.options.selected).addClass(this.options.selectedClass).focus()},onDocumentClick:function(e){jQuery(e.target).find(this.el).length&&jQuery("body").hasClass("glsr-focus")&&this.clearResults()},onDocumentKeydown:function(e){if(this.options.results){if(GLSR.keys.ESC===e.which&&this.clearResults(),GLSR.keys.ENTER===e.which||GLSR.keys.SPACE===e.which){var t=this.options.resultsEl.find("."+this.options.selectedClass);t&&t.trigger("click")}GLSR.keys.UP===e.which&&(e.preventDefault(),this.navigateResults(-1)),GLSR.keys.DOWN===e.which&&(e.preventDefault(),this.navigateResults(1))}},onResultClick:function(e){e.preventDefault(),"function"==typeof this.options.onResultClick&&this.options.onResultClick.call(this,e),this.clearResults()},onSearchInput:function(e){return this.abort(),this.searchTerm===e.target.value&&this.options.results.length?this.displayResults(this.options.results):(this.options.resultsEl.empty(),this.options.selected=-1,this.searchTerm=e.target.value,""===this.searchTerm?this.reset():(this.el.addClass("is-active"),void(this.searchRequest=wp.ajax.post(site_reviews.action,{_nonce:site_reviews.ajaxnonce,request:{action:this.options.action,exclude:this.options.exclude,search:this.searchTerm}}).done(function(e){this.el.removeClass("is-active"),this.displayResults(e.items?e.items:e.empty),this.options.results=this.options.resultsEl.children(),delete this.searchRequest}.bind(this)))))},onSearchKeyup:function(e){GLSR.keys.ESC===e.which&&this.reset(),GLSR.keys.ENTER===e.which&&this.onSearchInput(e)},reset:function(){this.clearResults(),this.options.results={},this.options.searchEl.val("")}},GLSR.search.prototype.deleteEntry=function(e){var t=this.options.entriesEl.children("tr").eq(e),s=this;t.find("td").css({backgroundColor:"#faafaa"}),t.fadeOut(350,function(){jQuery(this).remove(),s.options.results={},s.reindexRows(),s.setVisibility()})},GLSR.search.prototype.makeSortable=function(){this.options.entriesEl.on("click","a.delete",this.onEntryDelete.bind(this)),this.options.entriesEl.sortable({items:"tr",tolerance:"pointer",start:function(e,t){t.placeholder.height(t.helper[0].scrollHeight)},sort:function(e,t){var s=e.pageY-jQuery(this).offsetParent().offset().top-t.helper.outerHeight(!0)/2;t.helper.css({top:s+"px"})}})},GLSR.search.prototype.onEntryDelete=function(e){e.preventDefault(),this.deleteEntry(jQuery(e.target).closest("tr").index())},GLSR.search.prototype.onUnassign=function(e){e.preventDefault();var t=this.el.find(".description");this.el.find("input#assigned_to").val(""),t.find("a").css({color:"#c00"}),t.fadeOut("fast",function(){jQuery(this).html("").show()})},GLSR.search.prototype.reindexRows=function(){var i=this;this.options.exclude=[],this.options.entriesEl.children("tr").each(function(s){jQuery(this).find(".glsr-string-td2").children().filter(":input").each(function(){var e=jQuery(this),t=e.attr("name").replace(/\[\d+\]/i,"["+s+"]");e.attr("name",t),e.is("[data-id]")&&i.options.exclude.push({id:e.val()})})})},GLSR.search.prototype.setVisibility=function(){var e=0<this.options.entriesEl.children().length?"remove":"add";this.options.entriesEl.parent()[e+"Class"]("glsr-hidden")},GLSR.shortcode.close=function(e){var t=jQuery(e=e||".glsr-mce-button");t.length&&t.removeClass("active").parent().find(".glsr-mce-menu").hide()},GLSR.shortcode.open=function(e){jQuery(e).addClass("active").parent().find(".glsr-mce-menu").show()},GLSR.shortcode.toggle=function(e){e.preventDefault(),jQuery(this).hasClass("active")?GLSR.shortcode.close(this):GLSR.shortcode.open(this)},GLSR.shortcode.trigger=function(e){e.preventDefault(),GLSR.shortcode.current=jQuery(this).attr("data-shortcode"),GLSR.shortcode.current&&(tinymce.get(window.wpActiveEditor)?tinymce.execCommand("GLSR_Shortcode"):(jQuery("#scTemp").length||(jQuery("body").append('<textarea id="scTemp" style="display: none;" />'),tinymce.init({mode:"exact",elements:"scTemp",external_plugins:site_reviews.tinymce,plugins:["glsr_shortcode","wplink"]})),setTimeout(function(){tinymce.execCommand("GLSR_Shortcode")},200)),setTimeout(function(){GLSR.shortcode.close()},100))},GLSR.shortcode.create=function(e){var o=tinymce.get(e);if(o){var t={action:site_reviews.action,request:{action:"mce-shortcode",shortcode:GLSR.shortcode.current}};jQuery.post(site_reviews.ajaxurl,t,function(n){if(n.body){if(0===n.body.length)return window.send_to_editor("["+n.shortcode+"]"),void GLSR.shortcode.destroy();var e=[{text:n.ok,classes:"btn glsr-btn primary",onclick:function(){var e,t,s,i;for(var n in i=o.windowManager.getWindows()[0],s=!0,t=site_reviews.shortcodes[GLSR.shortcode.current])if(t.hasOwnProperty(n)&&void 0!==(e=i.find("#"+n)[0])&&""===e.state.data.value){s=!1,alert(t[n]);break}s&&i.submit()}},{text:n.close,onclick:"close"}],t={title:n.title,body:n.body,classes:"glsr-mce-popup",minWidth:320,buttons:e,onsubmit:function(e){var t="",s=GLSR.shortcode.normalize(e.data);for(var i in s)s.hasOwnProperty(i)&&""!==s[i]&&(t+=" "+i+'="'+s[i]+'"');window.send_to_editor("["+n.shortcode+t+"]")},onclose:function(){GLSR.shortcode.destroy()}};n.ok.constructor===Array&&(t.buttons[0].text=n.ok[0],t.buttons[0].onclick="close",delete t.buttons[1]),o.windowManager.open(t)}})}},GLSR.shortcode.normalize=function(e){var t={site_reviews:["author","avatar","date","excerpt","rating","response","title"],site_reviews_form:["email","name","terms","title"],site_reviews_summary:["bars","rating","stars","summary"]},s=[];for(var i in e)if(e.hasOwnProperty(i)){if(t.hasOwnProperty(GLSR.shortcode.current)){var n="";0===i.lastIndexOf("hide_",0)&&(n=i.substring(5)),-1<t[GLSR.shortcode.current].indexOf(n)&&(e[i]&&s.push(n),delete e[i])}"count"!==i||jQuery.isNumeric(e[i])||(e[i]=""),"id"===i&&(e[i]=(+new Date).toString(36))}return e.hide=s.join(","),e},GLSR.shortcode.destroy=function(){var e=jQuery("#scTemp");e.length&&(tinymce.get("scTemp").remove(),e.remove())},jQuery(function(n){var e=GLSR.getURLParameter("fix"),t=n("#contentdiv > textarea");e&&n('td [data-key="'+e+'"]').focus(),t.length&&(GLSR.textareaResize(t),n(document).on("wp-window-resized.editor-expand",function(){GLSR.textareaResize(t)})),n("form").on("change",":input",GLSR.onFieldChange),n("form").on("click","#clear-log",GLSR.onClearLog),GLSR.colorControls(),GLSR.pinned.events(),n.each(site_reviews_pointers.pointers,function(e,t){GLSR.pointers(t)}),n(document).on("click",function(e){n(e.target).closest(".glsr-mce").length||GLSR.shortcode.close()}),n(document).on("click",".glsr-mce-button",GLSR.shortcode.toggle),n(document).on("click",".glsr-mce-menu-item",GLSR.shortcode.trigger),n(document).on("click","a.change-site-review-status",GLSR.onChangeStatus),n(document).on("click",".branch-4 .toggle-row, .branch-4-1 .toggle-row, .branch-4-2 .toggle-row",function(){n(this).closest("tr").toggleClass("is-expanded")}),new GLSR.search("#glsr-search-translations",{action:"search-translations",onInit:function(){this.makeSortable()},onResultClick:function(e){var s=n(e.target),t=s.data("entry"),i=wp.template("glsr-string-"+(t.p1?"plural":"single"));t.index=this.options.entriesEl.children().length,t.prefix=this.options.resultsEl.data("prefix"),i&&(this.options.entriesEl.append(i(t)),this.options.exclude.push({id:t.id}),this.options.results=this.options.results.filter(function(e,t){return t!==s.get(0)})),this.setVisibility()}}),new GLSR.search("#glsr-search-posts",{action:"search-posts",onInit:function(){this.el.on("click",".glsr-remove-button",this.onUnassign.bind(this))},onResultClick:function(e){var t=n(e.target),s=wp.template("glsr-assigned-post"),i={url:t.data("url"),title:t.text()};s&&(this.el.find("input#assigned_to").val(t.data("id")),this.el.find(".description").html(s(i)),this.el.on("click",".glsr-remove-button",this.onUnassign.bind(this)),this.reset())}}),n("#glsr-outdated-notice .notice-dismiss").on("click",function(e){GLSR.postAjax(e,{action:"dismiss-outdated-notice"})})});